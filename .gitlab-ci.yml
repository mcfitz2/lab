stages:
  - test
#  - linting
  - build-workflows
  - build
include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

# ansible-lint:
#   stage: linting
#   image: registry.gitlab.com/pipeline-components/ansible-lint:latest
#   script:
#     - export ANSIBLE_ROLES_PATH=$(pwd)/ansible/roles
#     - ansible-lint --show-relpath ansible

build:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  script:
    - cd ansible
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:$CI_COMMIT_SHORT_SHA
    - docker tag $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:$CI_COMMIT_SHORT_SHA $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:latest


build-workflows:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  script:
    - cd applications/greatlakes
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker compose build
    - docker compose push