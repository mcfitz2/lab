stages:
  - test
  - linting
  - build
include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

isort:
  stage: linting
  image: registry.gitlab.com/mafda/python-linting
  script:
    - isort applications/formula1 --check-only
  only:
    changes:
      - applications/formula1/**/*

black:
  stage: linting
  image: registry.gitlab.com/mafda/python-linting
  script:
    - black --check applications/formula1
  only:
    changes:
      - applications/formula1/**/*

flake8:
  stage: linting
  image: registry.gitlab.com/mafda/python-linting
  script:
    - flake8 applications/formula1
  only:
    changes:
      - applications/formula1/**/*

ansible-lint:
  stage: linting
  image: registry.gitlab.com/pipeline-components/ansible-lint:latest
  script:
    - cd ansible
    - export ANSIBLE_ROLES_PATH=$(pwd)/roles
    - ansible-lint --show-relpath .
  allow_failure: true
  only:
    changes:
      - ansible/**/*


build-image:
  parallel:
    matrix:
      - DIR: ansible
        IMAGE_SUFFIX: ansible
      - DIR: applications/prometheus-prefect-exporter
        IMAGE_SUFFIX: prometheus-prefect-exporter
      - DIR: applications/fidelity_calendar
        IMAGE_SUFFIX: fidelity_calendar
      - DIR: applications/habit
        IMAGE_SUFFIX: habit
      - DIR: applications/magic-mirror
        IMAGE_SUFFIX: mm-office
      - DIR: applications/magic-mirror-home
        IMAGE_SUFFIX: mm-living-room
      - DIR: applications/formula1
        IMAGE_SUFFIX: formula1
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  script:
    - /kaniko/executor
      --context $DIR
      --dockerfile $DIR/Dockerfile
      --destination "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_SUFFIX:${CI_COMMIT_TAG}"
    - /kaniko/executor
      --context ansible
      --dockerfile ansible/Dockerfile
      --destination "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_SUFFIX:latest"
  stage: build
  only:
    changes:
      - $DIR/**/*


build-workflows:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  only:
    changes:
      - applications/greatlakes/**/*
  script:
    - cd applications/greatlakes
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker compose build
    - docker compose push