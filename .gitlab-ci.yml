stages:
  - test
  - linting
  - build
include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

isort:
  stage: linting
  image: registry.gitlab.com/mafda/python-linting
  script:
    - isort applications/formula1 --check-only
  only:
    changes:
      - applications/formula1/**/*
      - .gitlab-ci.yaml
black:
  stage: linting
  image: registry.gitlab.com/mafda/python-linting
  script:
    - black --check applications/formula1
  only:
    changes:
      - applications/formula1/**/*
      - .gitlab-ci.yaml
flake8:
  stage: linting
  image: registry.gitlab.com/mafda/python-linting
  script:
    - flake8 applications/formula1
  only:
    changes:
      - applications/formula1/**/*
      - .gitlab-ci.yaml

ansible-lint:
  stage: linting
  image: registry.gitlab.com/pipeline-components/ansible-lint:latest
  script:
    - cd ansible
    - export ANSIBLE_ROLES_PATH=$(pwd)/roles
    - ansible-lint --show-relpath .
  allow_failure: true
  only:
    changes:
      - ansible/**/*
      - .gitlab-ci.yaml

build-image:
  parallel:
    matrix:
      - DIR: ansible
        IMAGE_SUFFIX: ansible
      - DIR: applications/prometheus-prefect-exporter
        IMAGE_SUFFIX: prometheus-prefect-exporter
      - DIR: applications/fidelity_calendar
        IMAGE_SUFFIX: fidelity_calendar
      - DIR: applications/habit
        IMAGE_SUFFIX: habit
      - DIR: applications/magic-mirror
        IMAGE_SUFFIX: mm-office
      - DIR: applications/magic-mirror-home
        IMAGE_SUFFIX: mm-living-room
      - DIR: applications/formula1
        IMAGE_SUFFIX: formula1
      - DIR: applications/greatlakes/airport_locations
        IMAGE_SUFFIX: airport-locations
      - DIR: applications/greatlakes/oauth-service
        IMAGE_SUFFIX: oauth
      - DIR: applications/greatlakes/uptime-service
        IMAGE_SUFFIX: uptime
      - DIR: applications/greatlakes/takeout
        IMAGE_SUFFIX: takeout
      - DIR: applications/greatlakes/row_counts
        IMAGE_SUFFIX: row-counts
      - DIR: applications/greatlakes/austin_energy
        IMAGE_SUFFIX: austin-energy
      - DIR: applications/greatlakes/fitbit_api
        IMAGE_SUFFIX: fitbit-api
      - DIR: applications/greatlakes/sms
        IMAGE_SUFFIX: sms
      - DIR: applications/greatlakes/calls
        IMAGE_SUFFIX: calls
      - DIR: applications/greatlakes/Dockerfile
        IMAGE_SUFFIX: ynab
      - DIR: applications/greatlakes/Dockerfile
        IMAGE_SUFFIX: weather
      - DIR: applications/greatlakes/instagram
        IMAGE_SUFFIX: instagram
      - DIR: applications/greatlakes/stocks
        IMAGE_SUFFIX: stocks
      - DIR: applications/greatlakes/gmail
        IMAGE_SUFFIX: gmail
      - DIR: applications/greatlakes/geocoding
        IMAGE_SUFFIX: geocoding
      - DIR: applications/greatlakes/strava_api
        IMAGE_SUFFIX: strava_api
      - DIR: applications/greatlakes/db_tasks
        IMAGE_SUFFIX: db_tasks
      - DIR: applications/greatlakes/wrench_a_part
        IMAGE_SUFFIX: wrench_a_part
      - DIR: applications/greatlakes/postgres_backup
        IMAGE_SUFFIX: postgres_backup
      - DIR: applications/greatlakes/mortgage_rates
        IMAGE_SUFFIX: amr
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  script:
    - /kaniko/executor
      --context $DIR
      --dockerfile $DIR/Dockerfile
      --destination "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_SUFFIX:${CI_COMMIT_TAG}"
    - /kaniko/executor
      --context ansible
      --dockerfile ansible/Dockerfile
      --destination "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_SUFFIX:latest"
  stage: build
  only:
    changes:
      - $DIR/**/*
      - .gitlab-ci.yaml