stages:
  - test
#  - linting
  - build
include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

# ansible-lint:
#   stage: linting
#   image: registry.gitlab.com/pipeline-components/ansible-lint:latest
#   script:
#     - export ANSIBLE_ROLES_PATH=$(pwd)/ansible/roles
#     - ansible-lint --show-relpath ansible

build-ansible:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  only:
    changes:
      - ansible/**/*
  script:
    - cd ansible
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:$CI_COMMIT_SHORT_SHA
    - docker tag $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:$CI_COMMIT_SHORT_SHA $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ansible_runner:latest


build-workflows:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  only:
    changes:
      - applications/greatlakes/**/*
  script:
    - cd applications/greatlakes
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker compose build
    - docker compose push

build-prefect-exporter:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  only:
    changes:
      - applications/prometheus-prefect-exporter/**/*
  script:
    - cd applications/prometheus-prefect-exporter
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/prometheus-prefect-exporter:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/prometheus-prefect-exporter:$CI_COMMIT_SHORT_SHA
    - docker tag $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/prometheus-prefect-exporter:$CI_COMMIT_SHORT_SHA $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/prometheus-prefect-exporter:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/prometheus-prefect-exporter:latest

build-fidelity-calendar:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  only:
    changes:
      - applications/fidelity_calendar/**/*
  script:
    - cd applications/fidelity_calendar
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/fidelity_calendar:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/fidelity_calendar:$CI_COMMIT_SHORT_SHA
    - docker tag $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/fidelity_calendar:$CI_COMMIT_SHORT_SHA $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/fidelity_calendar:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/fidelity_calendar:latest


build-habit:
  image: docker:latest
  services:
    - docker:dind
  stage: build
  only:
    changes:
      - applications/habit/**/*
  script:
    - cd applications/habit
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/habit:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/habit:$CI_COMMIT_SHORT_SHA
    - docker tag $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/habit:$CI_COMMIT_SHORT_SHA $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/habit:latest
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/habit:latest